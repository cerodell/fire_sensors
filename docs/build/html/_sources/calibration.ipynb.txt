{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "\n",
    "# Performance\n",
    "In a laboratory setting, we compared the low-cost UBC AQ sensors to a [GRIMM](https://www.grimm-aerosol.com/products-en/dust-monitors/the-dust-decoder/11-d/) OPC sensor (Model: 1.109).  We produced air-borne salt particles as a measurand by feeding salt solutions with known molar concentrations into an atomizer. After the atomizer made the air-borne salt particles, they traveled through an adjustable filter (enabling concentrations control) and into a 22L glass chamber containing the UBC AQ sensors (Fig 1). The Grimm OPC sensor pulled air from the glass chamber to sample the salt concentrations simultaneously. There was an exhaust port to maintain persistent salt concentration levels and a small fan within the glass chamber to mix the air. \n",
    "<img src=\"_static/img/chamber.jpeg\" alt=\"chamber\" width=\"200\"/>\n",
    "![chamber](_static/img/chamber.jpeg)\n",
    "\n",
    "The two OPC sensors were sampling at varied rates.\n",
    "<br>\n",
    "<br>\n",
    "\n",
    "The  UBC OPCs:   ~1.3 seconds\n",
    "<br>\n",
    "THE GRIMM OPC: 1 min \n",
    "<br>\n",
    "\n",
    "<br>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import context\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from functools import reduce\n",
    "import matplotlib.pyplot as plt\n",
    "from matplotlib.dates import DateFormatter\n",
    "import matplotlib.pylab as pylab\n",
    "\n",
    "from datetime import datetime, timedelta\n",
    "from pathlib import Path\n",
    "from context import data_dir, save_dir"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "## Call in the OPC data!\n",
    "UBC AQ data was one minute averaged to match the GRIMM sample rate."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "## define date of interest\n",
    "date_of_int = '20210430' # options 20210430 or 20210502\n",
    "\n",
    "\n",
    "def prepare_df(df):\n",
    "  \"\"\"\n",
    "  Function cleans UBC OPCs data by removing duplicate headers and dropping error values. \n",
    "  Once cleaned takes 1 min avg of data to match GRIM sample rate.\n",
    "  \"\"\"\n",
    "  df = df.drop(df[df.rtctime == 'rtctime'].index)\n",
    "  df = df[~df['pm10_env'].str.contains('Rec')]\n",
    "  time = pd.to_datetime(df['rtctime'])\n",
    "  df.index = pd.DatetimeIndex(pd.to_datetime(df['rtctime']))\n",
    "  df = df.drop(['rtctime'], axis=1)\n",
    "  df = df.astype(float)\n",
    "  df = df[df['pm10_env'] < 4000]\n",
    "  df = df[df['pm25_env'] < 4000]\n",
    "  df = df[df['pm100_env'] < 4000]\n",
    "\n",
    "  df = df.resample('1Min').mean()\n",
    "\n",
    "  return df\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Open the ubc opcs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pm01 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-01/\" + date_of_int + '.TXT'))\n",
    "df_pm02 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-02/\" + date_of_int + '.TXT'))\n",
    "df_pm03 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-03/\" + date_of_int + '.TXT'))\n",
    "df_pm04 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-04/\" + date_of_int + '.TXT'))\n",
    "df_pm05 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-05/\" + date_of_int + '.TXT'))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Open the grim opc"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "try:\n",
    "  df_grim = pd.read_csv(str(data_dir) + f'/GRIM/{date_of_int}.csv')\n",
    "  df_grim['date & time'] = pd.to_datetime(df_grim['date & time'])\n",
    "except:\n",
    "  pathlist = sorted(Path(str(data_dir) + '/2021_OPCintercomparison/').glob(f'{date_of_int}*'))\n",
    "  sheets = ['PM values', 'Count values', 'Mass values', 'Log values']\n",
    "  df_grim = [pd.read_excel(f'{pathlist[0]}/{pathlist[0].stem}_sample01.xlsx', sheet_name= sheet, skiprows=4, engine='openpyxl') for sheet in sheets]\n",
    "  df_grim = reduce(lambda x, y: pd.merge(x, y, on='date & time'), df_grim)\n",
    "  df_grim['date & time'] = pd.to_datetime(df_grim['date & time'], dayfirst=True)\n",
    "  df_grim.to_csv(str(data_dir) + f'/GRIM/{date_of_int}.csv', index=False)\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Define default font sizes"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "lines_to_next_cell": 2
   },
   "outputs": [],
   "source": [
    "params = {\n",
    "         'xtick.labelsize':14,\n",
    "         'ytick.labelsize': 14,\n",
    "          'axes.labelsize':14,\n",
    "\n",
    "         }\n",
    "\n",
    "pylab.rcParams.update(params)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot PM 1.0 \n",
    "Figure shows time series comparison of the measured PM 1.0 contractions of four UBC AQ Sensors [UBC-PM-01 (orange), UBC-PM-03 (green), UBC-PM-04 (red), UBC-PM-05 (blue)] and the GRIM sensor [GRIMM (blue)]. The time series shows one minute averaged PM 1.0 contractions incremented from 2021-04-30 09:27:00 unitl 2021-04-30 21:36:00. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "grim_vars = list(df_grim)\n",
    "ubc_vars = list(df_pm01)\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 1 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM1 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm10_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm10_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm10_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm10_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm10_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Plot PM 2.5 \n",
    "Figure shows time series comparison of the measured PM 2.5 contractions of four UBC AQ Sensors [UBC-PM-01 (orange), UBC-PM-03 (green), UBC-PM-04 (red), UBC-PM-05 (blue)] and the GRIM sensor [GRIMM (blue)]. The time series shows one minute averaged PM 1.0 contractions incremented from 2021-04-30 09:27:00 unitl 2021-04-30 21:36:00. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 2.5 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM2.5 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm25_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm25_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm25_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm25_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm25_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot PM 10 \n",
    "Figure shows time series comparison of the measured PM 10 contractions of four UBC AQ Sensors [UBC-PM-01 (orange), UBC-PM-03 (green), UBC-PM-04 (red), UBC-PM-05 (blue)] and the GRIM sensor [GRIMM (blue)]. The time series shows one minute averaged PM 1.0 contractions incremented from 2021-04-30 09:27:00 unitl 2021-04-30 21:36:00. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 10.0 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM10 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm100_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm100_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm100_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm100_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm100_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "## Preliminary Results\n",
    "We see the UBC-AQ sensors are performing marginally well at PM 1.0 concentrations. However,  the UBC-AQ sensors are grossly over-predicting the concentration levels of PM 2.5 and 10. Let's figure out why this is happening. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot counts of particle sizes through time.\n",
    "The figure shows the counts/liter of particles of size XX um. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "lines_to_next_cell": 0
   },
   "outputs": [],
   "source": [
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.suptitle(\"Counts/liter of particles of size XX um\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "var_list = list(df_grim)[7:38]\n",
    "# var_list = list(df_grim)[7:16]\n",
    "for var in var_list:\n",
    "  ax.plot(df_grim['date & time'],df_grim[var], lw = 2.0, label = var[:-2])\n",
    "ax.set_ylabel('Counts/liter')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "ax.legend(\n",
    "  bbox_to_anchor=(1.2, 1.2),\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot counts of particle sizes averaged over time.\n",
    "The figure shows time averaged counts/liter of particles of size XX um. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.suptitle(\"Time averaged counts/liter of particles of size XX um\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "var_list = list(df_grim)[7:38]\n",
    "var_labels = [var[:-2] for var in var_list]\n",
    "df_grim_mean = df_grim[var_list].mean()\n",
    "\n",
    "ax.bar(var_labels,df_grim_mean)\n",
    "ax.set_ylabel('Counts/liter')\n",
    "ax.set_xlabel('Particles of size XX um')\n",
    "ax.set_xticklabels(var_labels, rotation = 45)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "jupytext": {
   "cell_metadata_filter": "-all",
   "main_language": "python",
   "notebook_metadata_filter": "-all"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
