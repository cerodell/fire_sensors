{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "\n",
    "## Optical Particle Counter (OPC) Calibration\n",
    "The calibration was done by using salt solutions with varied molar concentrations. The salt solution was fed into an atomizer providing air-born salt particles. The particles were forced through an adjustable filter enabling varied concentrations and into a 22L glass chamber where the UBC OPC sensors were located. The Grimm OPC sensor pulled air from the chamber to sample the salt concentrations as well. There was an exhaust port to maintain persistent salt concentration levels and a small fan within the chamber to mix the air. \n",
    "\n",
    "The two OPC sensors were sampling at varied rates.\n",
    "<br>\n",
    "<br>\n",
    "\n",
    "The  UBC OPCs:   ~1.3 seconds\n",
    "<br>\n",
    "THE GRIMM OPC: 1 min \n",
    "<br>\n",
    "\n",
    "<br>\n",
    "TODO add images of set up"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import context\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "from functools import reduce\n",
    "import matplotlib.pyplot as plt\n",
    "from matplotlib.dates import DateFormatter\n",
    "import matplotlib.pylab as pylab\n",
    "\n",
    "from datetime import datetime, timedelta\n",
    "from pathlib import Path\n",
    "from context import data_dir, save_dir"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "## Lets call in the OPC data!"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "## define date of interest\n",
    "date_of_int = '20210430' # options 20210430 or 20210502\n",
    "\n",
    "\n",
    "def prepare_df(df):\n",
    "  \"\"\"\n",
    "  Function cleans UBC OPCs data by removeing duplicate headers and droping error values. \n",
    "  Once cleaned takes 1 min avg of data to match GRIM sample rate\n",
    "  \"\"\"\n",
    "  df = df.drop(df[df.rtctime == 'rtctime'].index)\n",
    "  df = df[~df['pm10_env'].str.contains('Rec')]\n",
    "  time = pd.to_datetime(df['rtctime'])\n",
    "  df.index = pd.DatetimeIndex(pd.to_datetime(df['rtctime']))\n",
    "  df = df.drop(['rtctime'], axis=1)\n",
    "  df = df.astype(float)\n",
    "  df = df[df['pm10_env'] < 4000]\n",
    "  df = df[df['pm25_env'] < 4000]\n",
    "  df = df[df['pm100_env'] < 4000]\n",
    "\n",
    "  df = df.resample('1Min').mean()\n",
    "\n",
    "  return df\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Open the ubc opcs"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_pm01 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-01/\" + date_of_int + '.TXT'))\n",
    "df_pm02 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-02/\" + date_of_int + '.TXT'))\n",
    "df_pm03 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-03/\" + date_of_int + '.TXT'))\n",
    "df_pm04 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-04/\" + date_of_int + '.TXT'))\n",
    "df_pm05 = prepare_df(pd.read_csv(str(data_dir) + \"/UBC-PM-05/\" + date_of_int + '.TXT'))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Open the grim opc"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "try:\n",
    "  df_grim = pd.read_csv(str(data_dir) + f'/GRIM/{date_of_int}.csv')\n",
    "  df_grim['date & time'] = pd.to_datetime(df_grim['date & time'])\n",
    "except:\n",
    "  pathlist = sorted(Path(str(data_dir) + '/2021_OPCintercomparison/').glob(f'{date_of_int}*'))\n",
    "  sheets = ['PM values', 'Count values', 'Mass values', 'Log values']\n",
    "  df_grim = [pd.read_excel(f'{pathlist[0]}/{pathlist[0].stem}_sample01.xlsx', sheet_name= sheet, skiprows=4, engine='openpyxl') for sheet in sheets]\n",
    "  df_grim = reduce(lambda x, y: pd.merge(x, y, on='date & time'), df_grim)\n",
    "  df_grim['date & time'] = pd.to_datetime(df_grim['date & time'], dayfirst=True)\n",
    "  df_grim.to_csv(str(data_dir) + f'/GRIM/{date_of_int}.csv', index=False)\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "Define default font sizes"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {
    "lines_to_next_cell": 2
   },
   "outputs": [],
   "source": [
    "params = {\n",
    "         'xtick.labelsize':14,\n",
    "         'ytick.labelsize': 14,\n",
    "          'axes.labelsize':14,\n",
    "\n",
    "         }\n",
    "\n",
    "pylab.rcParams.update(params)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot PM 1.0 "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "grim_vars = list(df_grim)\n",
    "ubc_vars = list(df_pm01)\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 1 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM1 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm10_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm10_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm10_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm10_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm10_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot PM 2.5 "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 2.5 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM2.5 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm25_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm25_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm25_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm25_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm25_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "lines_to_next_cell": 0
   },
   "source": [
    "### Plot PM 10 "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "\n",
    "fig = plt.figure(figsize=(14, 6))\n",
    "fig.autofmt_xdate()\n",
    "xfmt = DateFormatter(\"%m-%d %H:00\")\n",
    "fig.suptitle(r\"PM 10.0 ($\\frac{\\mu g}{m^3}$)\", fontsize=16)\n",
    "ax = fig.add_subplot(1, 1, 1)\n",
    "ax.plot(df_grim['date & time'],df_grim['PM10 [ug/m3]'], lw = 4.0, label = 'GRIM')\n",
    "ax.plot(df_pm01.index,df_pm01['pm100_env'], label = 'UBC-PM-01')\n",
    "# ax.plot(df_pm02.index,df_pm02['pm100_env'], label = 'UBC-PM-02')\n",
    "ax.plot(df_pm03.index,df_pm03['pm100_env'], label = 'UBC-PM-03')\n",
    "ax.plot(df_pm04.index,df_pm04['pm100_env'], label = 'UBC-PM-04')\n",
    "ax.plot(df_pm05.index,df_pm05['pm100_env'], label = 'UBC-PM-05')\n",
    "ax.set_ylabel(r'$\\frac{\\mu g}{m^3}$')\n",
    "ax.set_xlabel('Time (MM-DD HH)')\n",
    "ax.legend(\n",
    "    loc=\"upper center\",\n",
    "    bbox_to_anchor=(0.5, 1.04),\n",
    "    ncol=6,\n",
    "    fancybox=True,\n",
    "    shadow=True,\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "jupytext": {
   "cell_metadata_filter": "-all",
   "main_language": "python",
   "notebook_metadata_filter": "-all"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
